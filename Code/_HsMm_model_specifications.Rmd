---
title: "HsMm model states specifications"
author: "Laura Symul"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  bookdown::html_document2: 
    theme: flatly
    highlight: haddock
    toc: yes
    toc_float: true
    toc_depth: 5
    number_sections: true
    fig_caption: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```


```{r hsmm_model setup, include = FALSE, eval = TRUE, cache = FALSE}
source("Scripts/00_setup.R")
```

# Model specifications

```{r model hsmm init}
hsmm = list()
```


## States

```{r model states, echo = FALSE}

hsmm$states = data.frame(
  names = c("Menses","Early Foll","high E","Ovu - 1","Ovu","Ovu + 2","Luteal",
            "Pregnancy","Pregnancy with Loss","Loss",
            "Pregnancy with Birth - 1st trimester", 
            "Pregnancy with Birth - 2nd trimester", 
            "Pregnancy with Birth - 3rd trimester","Birth",
            "Post-Partum","Breast-Feeding",
            "Anovulatory cycle"), 
  abbr = c("M","lE","hE","preO","O","postO","Lut","P","PL","L","PB1","PB2","PB3","B","PP","BF","Ano"), 
  colors = c("red3","lightblue1","skyblue1","blue","black","gold3","gold1",
             "deeppink", #pregnancy day
             "pink3", "pink4", #pregnancy with loss
             "plum1","plum2", "plum3","plum4", # pregnancy with birth 1,2,3 + birth
             "darkseagreen1","darkseagreen3", # PP + BF
             "gray"), # ,"red"
  group = c("M",rep("Ovulatory",6), "P",rep("Loss",2),rep("Pregnancy",4),rep("Post-Delivery",2), "Anovulatory"),
  stringsAsFactors = FALSE
)
hsmm$states$number = 1:nrow(hsmm$states)

# hsmm$states$l is the (x,y) coordinates for the graphical representation layout
hsmm$states$l = matrix(c(0,0, #M  
                         0.5,2, #lE
                         1.3,1.75, #hE
                         1.75,1, #preO
                         2,0, #O
                         1.75,-1, #postO  
                         0.6,-2, #lut
                         -0.3, -2, #P
                         -0.8, -0.7, #PL
                         -0.8,0.5, #L
                         -1.7, -1.5, #PB1
                         -1.8, -1.25, #PB2
                         -1.9, -1, #PB3
                         -2, 0.15, #B
                         -1, 1.3, #PP
                         -1.5, 1.8, #BF
                         1,0.5 #Ano
                         ),
                       byrow = TRUE,
                       ncol = 2
)
hsmm$n_states = nrow(hsmm$states)

hsmm$states

```

## Initial Probabilities

```{r init}
# Initial Probabilities
hsmm$init = c(10,rep(1,hsmm$n_states-1))
hsmm$init = hsmm$init/sum(hsmm$init)
```

## Transition Probabilities

```{r transitions, echo = FALSE}

# Transition Probabilities
hsmm$trans = matrix(rep(0, hsmm$n_states*hsmm$n_states), nrow = hsmm$n_states, dimnames = list(hsmm$states$abbr,hsmm$states$abbr)) 

hsmm$trans[which(hsmm$states$abbr == "M"),which(hsmm$states$abbr == "lE")] = 0.95
hsmm$trans[which(hsmm$states$abbr == "M"),which(hsmm$states$abbr == "Ano")] = 0.05

hsmm$trans[which(hsmm$states$abbr == "lE"),which(hsmm$states$abbr == "hE")] = 1

hsmm$trans[which(hsmm$states$abbr == "hE"),which(hsmm$states$abbr == "lE")] = 0.1
hsmm$trans[which(hsmm$states$abbr == "hE"),which(hsmm$states$abbr == "preO")] = 0.9

hsmm$trans[which(hsmm$states$abbr == "preO"),which(hsmm$states$abbr == "O")] = 1

hsmm$trans[which(hsmm$states$abbr == "O"),which(hsmm$states$abbr == "postO")] = 1

hsmm$trans[which(hsmm$states$abbr == "postO"),which(hsmm$states$abbr == "Lut")] = 1

hsmm$trans[which(hsmm$states$abbr == "Lut"),which(hsmm$states$abbr == "M")] = 0.75
hsmm$trans[which(hsmm$states$abbr == "Lut"),which(hsmm$states$abbr == "P")] = 0.25

hsmm$trans[which(hsmm$states$abbr == "P"),which(hsmm$states$abbr == "PL")] = 0.3
hsmm$trans[which(hsmm$states$abbr == "P"),which(hsmm$states$abbr == "PB1")] = 0.7

hsmm$trans[which(hsmm$states$abbr == "PL"),which(hsmm$states$abbr == "L")] = 1

hsmm$trans[which(hsmm$states$abbr == "L"),which(hsmm$states$abbr == "lE")] = 0.9
hsmm$trans[which(hsmm$states$abbr == "L"),which(hsmm$states$abbr == "Ano")] = 0.1

hsmm$trans[which(hsmm$states$abbr == "PB1"),which(hsmm$states$abbr == "PB2")] = 1
hsmm$trans[which(hsmm$states$abbr == "PB2"),which(hsmm$states$abbr == "PB3")] = 1
hsmm$trans[which(hsmm$states$abbr == "PB3"),which(hsmm$states$abbr == "B")] = 1

hsmm$trans[which(hsmm$states$abbr == "B"),which(hsmm$states$abbr == "PP")] = 0.5
hsmm$trans[which(hsmm$states$abbr == "B"),which(hsmm$states$abbr == "BF")] = 0.5

hsmm$trans[which(hsmm$states$abbr == "PP"),which(hsmm$states$abbr == "lE")] = 1

hsmm$trans[which(hsmm$states$abbr == "BF"),which(hsmm$states$abbr == "lE")] = 1

hsmm$trans[which(hsmm$states$abbr == "Ano"),which(hsmm$states$abbr == "M")] = 1


hsmm$trans = hsmm$trans/apply(hsmm$trans,1,sum)

hsmm$trans_no_names = hsmm$trans
colnames(hsmm$trans_no_names) = NULL
rownames(hsmm$trans_no_names) = NULL

round(hsmm$trans, 2)
```


```{r transition viz, fig.height=6, fig.width=6}

g = graph_from_adjacency_matrix(hsmm$trans, weighted = TRUE, mode = "directed")
E(g)$width <- 1+E(g)$weight*5
plot(g,# edge.arrow.size=0.75, 
     vertex.size=30, vertex.frame.color="white", 
     vertex.label.color="white", vertex.label.family  = "sans",
     vertex.color = hsmm$states$colors[match(V(g)$name,  hsmm$states$abbr)],
     layout = hsmm$states$l
)

```

```{r transition viz anim, fig.height=6, fig.width=6}

is = list(i1 = c(1:7), i2 = c(17), i3 = c(8), i4 = c(9,11,12,13), i5 = c(10), i6 = c(14,15,16))  

for(i in 1:length(is)){
  ii = unlist(is[1:i])
  g = graph_from_adjacency_matrix(hsmm$trans[ii,ii], weighted = TRUE, mode = "directed")
  E(g)$width <- 1+E(g)$weight*5
  igraph::plot.igraph(g,# edge.arrow.size=0.75, 
       vertex.size=50, vertex.frame.color="white", 
       vertex.label.color="white", vertex.label.family  = "sans",
       label.label.size = 2,
       vertex.color = hsmm$states$colors[match(V(g)$name,  hsmm$states$abbr)],
       layout = hsmm$states$l[ii,],
       rescale = FALSE,
       xlim = range(hsmm$states$l[,1]),
       ylim = range(hsmm$states$l[,2]),
       margin = 0.5,
       frame = FALSE
       #asp = 1
  )
}

```



## Sojourn

The package `mhsmm` allows for sojourn distributions of type gamma, poisson or non-parametric.
Because some of the states have sojourn distributions that are not gamma or poisson, we will use non-parametric distributions for all states.

Note that the non-parametric distributions have to be given as matrices that are of the length of the time-series to be labelled.
Here, we will thus provide a matrix that is of dimension n x 1000 days (the longest state, i.e. breast-feeding is likely to be shorter than 3 years).
This matrix will have to be padded with zeros or truncated depending on the input time-series.

The distributions for the menses, the follicular and the luteal phases durations will be based on the distribution of the corresponding phases as estimated in Symul et al., npj Digital Medicine, 2019. 

```{r sojourn}

Nd = 1000
x = 1:Nd

#initialization
hsmm$sojourn = matrix(nrow = hsmm$n_states, ncol = Nd)

oneday = c(1, rep(0,Nd-1))
twodays = c(0,1, rep(0,Nd-2))
uptoNdays = function(N,Nd){return(c(rep(1/N,N), rep(0,Nd-N)))}

# load FAM paper data
FAM_agg_sojourn = read_feather(path = paste0(IO$tmp_data,"FAM_kindara_hsmm_states_agg.feather"))

# M
M_gammafit = gammafit(x = FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "M"])
hsmm$sojourn[hsmm$states$abbr == "M",] = dgamma(x, shape = M_gammafit$shape, scale = M_gammafit$scale)
hsmm$sojourn[hsmm$states$abbr == "M",1] = 0
hsmm$sojourn[hsmm$states$abbr == "M",] = 
  hsmm$sojourn[hsmm$states$abbr == "M",] / sum(hsmm$sojourn[hsmm$states$abbr == "M",])

# lE
lE_gammafit = gammafit(x = FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "lE"])
hsmm$sojourn[hsmm$states$abbr == "lE",] = dgamma(x, shape = lE_gammafit$shape, scale = lE_gammafit$scale)

# hE
hE_gammafit = gammafit(x = pmax(1,FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "hE"]-1))
hsmm$sojourn[hsmm$states$abbr == "hE",] = dgamma(x, shape = hE_gammafit$shape, scale = hE_gammafit$scale)

# preO
hsmm$sojourn[hsmm$states$abbr == "preO",] = oneday
  
# O
hsmm$sojourn[hsmm$states$abbr == "O",] =  oneday

# postO
hsmm$sojourn[hsmm$states$abbr == "postO",] = twodays
  
# Lut
xlut = FAM_agg_sojourn$n_days[FAM_agg_sojourn$hsmm_states == "Lut"]
xlut[(xlut<7)|(xlut>17)] = NA 
lut_gammafit = gammafit(x = xlut[!is.na(xlut)])
hsmm$sojourn[hsmm$states$abbr == "Lut",] = dgamma(x, shape = lut_gammafit$shape, scale = lut_gammafit$scale)
#hist(xlut, breaks = seq(-0.5,max(xlut, na.rm = TRUE)+0.5, by = 1), xlim = c(0,30), freq = FALSE)
#points(dgamma(x, shape = lut_gammafit$shape, scale = lut_gammafit$scale), type = "l", xlim = c(0,30))
  
# P
hsmm$sojourn[hsmm$states$abbr == "P",] = oneday
  
# PL
hsmm$sojourn[hsmm$states$abbr == "PL",] = dgamma(x, shape = 1.5, scale = 30)  # dgamma(x, shape = 1.5, scale = 30) 
hsmm$sojourn[hsmm$states$abbr == "PL",183:length(x)] = 0
# L
hsmm$sojourn[hsmm$states$abbr == "L",] = hsmm$sojourn[hsmm$states$abbr == "M",]
  
# PBs
hsmm$sojourn[hsmm$states$abbr == "PB1",] = c(rep(0,12*7-1),1,rep(0, Nd-12*7)) # exactly 12 weeks (1st trimester)
hsmm$sojourn[hsmm$states$abbr == "PB2",] = c(rep(0,12*7-1),1,rep(0, Nd-12*7)) # exactly 12 weeks (2nd trimester)
hsmm$sojourn[hsmm$states$abbr == "PB3",] = dnorm(x, mean = 12*7, sd = 8) # approximately 12 weeks 
hsmm$sojourn[hsmm$states$abbr == "PB3",c(1:56,112:length(x))] = 0
  
# B
hsmm$sojourn[hsmm$states$abbr == "B",] = uptoNdays(N = 31, Nd = Nd)
  
# PP
hsmm$sojourn[hsmm$states$abbr == "PP",] = dnorm(x, mean = 7*7, sd = 10)

# BF
hsmm$sojourn[hsmm$states$abbr == "BF",] =  dgamma(x, shape = 1.8, scale = 150) 
hsmm$sojourn[hsmm$states$abbr == "BF",1:50] = 0
hsmm$sojourn[hsmm$states$abbr == "BF",] = 
  hsmm$sojourn[hsmm$states$abbr == "BF",]/sum(hsmm$sojourn[hsmm$states$abbr == "BF",])

# Ano
hsmm$sojourn[hsmm$states$abbr == "Ano",] = dgamma(x, shape = 3, scale = 20) 
hsmm$sojourn[hsmm$states$abbr == "Ano",1:6] = 0
hsmm$sojourn[hsmm$states$abbr == "Ano",] = 
  hsmm$sojourn[hsmm$states$abbr == "Ano",] /sum(hsmm$sojourn[hsmm$states$abbr == "Ano",])


rm(x, Nd, M_gammafit, lE_gammafit, hE_gammafit, lut_gammafit, FAM_agg_sojourn, oneday, twodays, uptoNdays)

```

```{r sojourn VIZ }

sojourn = as.data.frame(t(hsmm$sojourn))
colnames(sojourn) = hsmm$states$abbr
sojourn$day = 1:nrow(sojourn)
sojourn_long = melt(sojourn, id.vars = "day")
colnames(sojourn_long) = c("day","State","d")
sojourn_long$color = hsmm$states$colors[match(sojourn_long$State, hsmm$states$abbr)]
j = which(sojourn_long$d > 0.0001)
ggplot(sojourn_long[j,])+
  geom_area(aes(x = day, y = d, fill = color, col = color))+
  scale_color_identity()+scale_fill_identity()+
  expand_limits(x = 0)+
  facet_wrap(State~., scale = "free", nrow = 5, dir = "v")


ggplot(sojourn_long)+
  geom_line(aes(x = day, y = d, col = color))+
  xlim(c(0,280))+
  scale_color_identity()
```





```{r save hsmm, echo = FALSE}
save(hsmm, file = paste0(IO$tmp_data, "hsmm.Rdata"))
```


